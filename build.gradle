defaultTasks 'assemble'

subprojects {
    apply plugin: 'base'

    version = rootProject.version

    // Set a common build directory for all subprojects
    buildDir = "${rootProject.projectDir}/out"
    def commonDir = "${rootProject.projectDir}/common"
    def looseDir = "${buildDir}/loose/${project.name}"

    // Define a sync task in each subproject
    tasks.register('syncLoose', Sync) {
        includeEmptyDirs = false
        duplicatesStrategy = DuplicatesStrategy.EXCLUDE

        from("assets") {
            into 'assets'
        }
        from(commonDir)
        from('pack.mcmeta')
        from("${rootProject.projectDir}/CHANGELOG.md")
        from("${rootProject.projectDir}/LICENSE.md")
        into looseDir

        exclude '**/*.psd', '**/desktop.ini', '**/Thumbs.db'
    }

    // Define a zip task in each subproject
    tasks.register('zipPack', Zip) {
        includeEmptyDirs = false
        group = 'Build'
        description = "Builds the resource pack for MC version ${project.name}."

        archiveBaseName.set(rootProject.name)
        archiveAppendix.set("MC${project.name}")
        archiveVersion.set("v${rootProject.version}")
        archiveExtension.set('zip')

        destinationDirectory.set(buildDir)

        from(tasks.named('syncLoose'))
        dependsOn tasks.named('syncLoose') // Ensure syncLoose runs before zipping
    }

    // Add the zip task to the default tasks
    tasks.named('assemble').configure {
        dependsOn tasks.named('zipPack')
    }
}
